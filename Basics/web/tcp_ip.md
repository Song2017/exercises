# 图解TCP/IP

## 一 网络基础知识
### 计算机网络发展的7阶段
1. 批处理
事先将用户程序和数据装入卡带或磁带,并由计算机按照一定的顺序读取,
使用户所要执行的这些程序和数据能够一并批量得到处理的方式
2. 分时系统(TSS(Time Sharing System) )
它是指多个终端(由键盘、显示器等输入输出设备组成.最初还包括打字机) 
与同一个计算机连接,允许多个用户同时使用一台计算机的系统
3. 计算机间的通信技术
计算机与计算机之间由通信线路连接,人们能够很轻松地即时读取另一台计算机中的数据,
从而极大地缩短了传送数据的时间
人们不再局限于仅使用一台计算机进行处理,而是逐渐使用多台计算机分布式处理,最终
一并得到返回结果
4. 计算机网络的产生
20世纪70年代初期,人们开始实验基于分组交换技术的计算机网络,
并着手研究不同厂商的计算机之间相互通信的技术.到了80年代,一种能够互连多种计算机的网络随之诞生
5. 互联网的普及
通过连接不同厂商的计算机建立一个成本更低的网络环境.
而连接异构型计算机的通信网络技术就是现在我们所看到的互联网技术
6. 以互联网技术为中心的时代
IP网是互联网技术的产物.通过IP网,人们不仅可以实现电话
通信、电视播放,还能实现计算机之间的通信,建立互联网
7. 从"单纯建立连接"到"安全建立连接"
### TCP/IP
**互联网是由许多独立发展的网络通信技术融合而成.能够使它们之间不断融合并实现统一的正是TCP/IP技术**
TCP/IP是通信协议的统称,是IP、TCP、HTTP等协议的集合
1. 协议就是计算机与计算机之间通过网络实现通信时事先达成的一种"约定".
这种"约定"使那些由不同厂商的设备、不同的CPU以及不同的操作系统组成的计算机之间,
只要遵循相同的协议就能够实现通信
2. 分组交换协议
网络通信方式大致分为两种——电路交换和分组交换
+ 电路交换技术主要用于过去的电话网, 某条电路只是用来连接两台计算机的通信线路,意味着只需
在这两台计算机之间实现通信, 就独占线路进行数据传输. 但是, 并发用户数超过交换
机之间的通信线路数,就意味着通信根本无法实现.
为此, 人们想到新的方法就是分组交换协议
+ 分组交换是指将大数据分割为一个个叫做包(Packet)的较小单位进行传输的方法. 即让连接到通信电路的计算机将
所要发送的数据分成多个数据包,按照一定的顺序排列之后分别发送.这就是分组交换.
+ + 数据被细分后,所有的计算机就可以一齐收发数据,这样也就提高了通信线路的利用率.由于在分组的过程
中,已经在每个分组的首部写入了发送端和接收端的地址,所以即使同一条线路同时为多个用户提供服务,也可以明确区分每个分组数据发往的目的地,以及它是与哪台计算机进行的通信
+ + 分组交换的大致处理过程是：发送端计算机将数据分组发送给路由器,路由器收
到这些分组数据以后,缓存到自己的缓冲区,然后再转发给目标计算机.因此,分组交换也有另一个名称：蓄积交换
3. 网络的构成要素
+ 通信媒介与数据链路
现实当中计算机之间通过电缆相互连接。
电缆可以分为很多种，包括双绞线电缆、光纤电缆、同轴电缆、串行电缆等。
根据数据链路（Datalink，意指相互直连的设备之间进行通信所涉及的协议及其网络。为此，有众
多传输介质与之对应。具体细节可参考第3章。） 的不同选用的电缆类型也不尽相同。
而媒介本身也可以被划分为电波、微波等不同类型的电磁波
+ 网卡
计算机连接网络时，必须要使用网卡（全称为网络接口卡）。
网络接口卡（NIC（集成了连接局域网功能的设备。有时会被集成到计算机的主板中，有时也可以单独插入扩展槽使用。
NetworkInformation Center的缩写也是NIC，所以要注意区分。） ）有时也被叫做网络适配器、网卡、LAN卡
+ 中继器
中继器（Repeater）是在OSI模型的第1层——物理层面上延长网络的设备。
由电缆传过来的电信号或光信号经由中继器的波形调整和放大再传给另一个电缆
一般情况下，中继器的两端连接的是相同的通信媒介，但有的中继器也可以完成不同媒介之间的转接工作。
例如，可以在同轴电缆与光缆之间调整信号
+ 网桥/2层交换机
网桥是在OSI模型的第2层——数据链路层面上连接两个网络的设备。
它能够识别数据链路层中的数据帧 ，并将这些数据帧临时存储于内存，
再重新生成信号作为一个全新的帧转发给相连的另一个网段（具有分割、划分网络之意）
数据链路的数据帧中有一个数据位叫做FCS（用CRC（CyclicRedundancy Check，循环冗余校验码）方式校验数据帧中的位。） 
用以校验数据是否正确送达目的地
网桥还能通过地址自学机制和过滤功能控制网络流量（网络上传输的数据报文的数量。）
+ 路由器/3层交换机
路由器是在OSI模型的第3层——网络层面上连接两个网络、并对分组报文进行转发的设备。
网桥是根据物理地址（MAC地址）进行处理，而路由器/3层交换机则是根据IP地址进行处理的。
由此，TCP/IP中网络层的地址就成为了IP地址。路由器可以连接不同的数据链路。
路由器还有分担网络负荷的作用
+ 4～7层交换机
4～7层交换机负责处理OSI模型中从传输层至应用层的数据.
通过对多个IP地址配置同一个名字，每次查询到这个名字的客户得到其中的某一个地址，从而使
不同客户访问不同的服务器。该方法也称作循环复用DNS技术
+ 网关
网关是OSI参考模型中负责将从传输层到应用层的数据进行转换和转发的设备
网关不仅转发数据还负责对数据进行转换，它通常会使用一个表示层或应用层网关，
在两个不能进行直接通信的协议之间进行翻译，最终实现两者之间的通信
为了控制网络流量以及出于安全的考虑，有时会使用代理服务器（ProxyServer）。这种代理服务器也是网关的一种，称为应用网关
+ 现代网络实态
4. 协议分层与OSI参考模型
在OSI模型中,模型将通信协议中必要的功能分成了7层, 每个分层都接收由它下一层所提供的特定服务,
并且负责为自己的上一层提供特定的服务.上下层之间进行交互时所遵循的约定叫做"接口".
同一层之间的交互所遵循的约定叫做"协议".

| 分层名称| 功能 | 功能概览 | 设备 |
| -- | -- | -- | -- |
| 应用层 | 为应用程序提供服务并规定应用程序中通信相关的细节 | 邮件协议, 远程登录, 文件传输 |   4-7层交换机|
| 表示层 | 数据格式的转换 | 将设备固有的数据格式转换为网络标准传输格式 |4-7层交换机  |
| 会话层 | 负责建立和断开通信连接(数据流动的逻辑通路)以及数据的分割等数据传输相关的管理 | 逻辑通路管理 |4-7层交换机 |
| 传输层 | 管理两个节点之间的数据传输 | 起着可靠传输的作用 | 网关: 4-7层间进行协议转换| |
| 网络层 | 目标地址可以是多个网络通过路由器连接而成的.因此主要负责寻址和路由选择 | 将数据传输到目标地址 | 路由器|
| 数据链路层 | 负责物理层面上互连的、节点之间的通信传输 | 将0、1序列划分为具有意义的数据帧传送给对端 |网桥|
| 物理层 | 负责0、1比特流(0、1序列)与电压的高低、光的闪灭之间的互换 | | 中继器|
![在这里插入图片描述](images/OSI模型概览.png)     


## 二 TCP/IP基础知识
TCP(Transmission Control Protocol)和IP(Internet Protocol)
### 发展历史
分组交换技术实现的分组通信, 可以使多个用户同一时间共享一条通信线路进行通信,从而提高了线路的使用效率,
也降低了搭建线路的成本. 
1969年,为验证分组交换技术的实用性,研究人员搭建了一套网络, ARPANET(Advanced Research Projects
Agency Network,阿帕网)ARPANET网络组成之初,由于其节点个数的限制,TCP/IP的应用范围也受到一定的限制, 
到80年代UNIX工作站迅速普及, BSD UNIX的操作系统实现了TCP/IP协议, 那些大学和研究机构也逐渐开始将ARPANET连接到了NSFnet网络.
此后,基于TCP/IP而形成的世界性范围的网络——互联网(The Internet)便诞生了
以连接UNIX主机的形式连接各个终端节点,这一主要方式使互联网得到了迅速的普及
### 标准化
TCP/IP的协议的标准化过程与其他的标准化过程有所不同,
具有两大特点：一是具有开放性,二是注重实用性,即被标准化的协议能否被实际运用
需要标准化的协议,被人们列入RFC(Request For Comment)
(RFC从字面意义上看就是指征求意见表,属于一种征求协议相关意见的文档)
http://www.rfc-editor.org/rfc/
上面两个网址保存着所有RFC文件,网站中有一个名为rfc-index.txt的文件包含了所有RFC的概览
+ STD获取网址
http://www.rfc-editor.org/in-notes/std/
+ FYI获取网址
http://www.rfc-editor.org/in-notes/fyi/
### TCP/IP协议分层模型
| 分层名称| 协议 | 系统级别 |  数据单位 |
| -- | -- | -- | -- |
| 应用层 |   smtp, http, snmp   | 应用程序 |   消息|
| 表示层 |   mime, html, mib   | 应用程序 |  消息|
| 会话层 |   ftp   | 应用程序 |消息|
| 传输层 | TCP UDP | OS |  段|
| 网络层 | ARP IP ICMP | OS | 数据报| 
| 数据链路层 | 网卡层 | 设备驱动程序与网络接口 | 帧|
| 物理层 | 硬件 | 设备驱动程序与网络接口 | 0/1序列|

1. 互联网层(网络层)
互联网层使用IP协议,它相当于OSI模型中的第3层网络层.IP协议基于IP地址转发分包数据.
TCP/IP分层中的互联网层与传输层的功能通常由操作系统提供.尤其是路由器,它必须得实现通过互联网层转发分组数据包的功能.
此外,连接互联网的所有主机跟路由器必须都实现IP的功能.
+ IP
是跨越网络传送数据包,使整个互联网都能收到数据的协议.IP协议使数据能够发送到地球的另一端,这期间它使用IP地址作为主机的标识
IP还隐含着数据链路层的功能, 相互通信的主机之间不论经过怎样的底层数据链路都能够实现通信
虽然IP也是分组交换的一种协议,但是它不具有重发机制
+ ICMP
IP数据包在发送途中一旦发生异常导致无法到达对端目标地址时,需要给发送端发送一个发生异常的通知.ICMP就是为这一功能而制定的
+ ARP
从分组数据包的IP地址中解析出物理地址(MAC地址)的一种协议
2. 传输层
传输层最主要的功能就是能够让不同主机上的应用程序之间实现通信.
计算机内部,通常同一时间运行着多个程序.为此,必须分清是哪些程序与哪些程序在进行通信.识别这些应用程序的是端口号
+ TCP
TCP是一种面向有连接的传输层协议.它可以保证两端通信主机之间的通信可达.
TCP能够正确处理在传输过程中丢包、传输顺序乱掉等异常情况.此外,TCP还能够有效利用带宽,缓解网络拥堵.
然而,为了建立与断开连接,有时它需要至少7次的发包收包,导致网络流量的浪费
+ UDP
UDP有别于TCP,它是一种面向无连接的传输层协议.UDP不会关注对端是否真的收到了传送过去的数据,
如果需要检查对端是否收到分组数据包,或者对端是否连接到网络,则需要在应用程序中实现.
UDP常用于分组数据较少或多播、广播通信以及视频通信等多媒体领域
3. 应用层(会话层以上的分层)
TCP/IP的分层中,将OSI参考模型中的会话层、表示层和应用层的功能都集中到了应用程序中实现.
这些功能有时由一个单一的程序实现,有时也可能会由多个程序实现
+ WWW
万维网,是一种互联网上数据读取的规范
用户通过浏览器, 借助鼠标和键盘就可以轻轻松松地在网上自由地冲浪, 访问服务器上的各种资源.
浏览器与服务端之间通信所用的协议是HTTP(HyperText TransferProtocol).
所传输数据的主要格式是HTML(HyperText MarkupLanguage).WWW中的HTTP属于OSI应用层的协议,而HTML属于表示层的协议
+ 电子邮件(E-Mail)
SMTP(Simple Mail Tranfer Protocol)
电子邮件的格式由MIME(用来定义邮件数据格式一种规范) 协议扩展以后,就可以发送声音、图像等各式各样的信息.
MIME属于OSI参考模型的第6层——表示层
+ 文件传输
该过程使用的协议叫做FTP(File Transfer Prototol), 在FTP中进行文件传输时会建立两个TCP连接,分别是发出传输请
求时所要用到的控制连接与实际传输数据时所要用到的数据连接(这两种连接的控制管理属于会话层的功能)
+ 远程登录(TELNET与SSH)
TCP/IP网络中远程登录常用
TELNET(TELetypewriter NETwork的缩写.有时也称作默认协议)和SSH(SSH是Secure SHell的缩写)
+ 网络管理(SNMP)
SNMP(Simple NetworkManagement Protocol).使用SNMP管理的主机、网桥、路由器等
称作SNMP代理(Agent),而进行管理的那一段叫做管理器(Manager).SNMP正是这个Manager与Agent所要用到的协议.
在SNMP的代理端,保存着网络接口的信息、通信数据量、异常数据量以及设备温度等信息.这些信息可以通过MIB(ManagementInformation Base)(MIB也被称为是一种可透过网络的结构变量) 访问.
因此,在TCP/IP的网络管理中,SNMP属于应用协议,MIB属于表示层协议.
### TCP/IP分层模型与通信示例
每个分层中,都会对所发送的数据附加一个首部,在这个首部中包含了该层必要的信息,如发送的目标地址以及协议相关信息.
通常,为协议提供的信息为包首部,所要发送的内容为数据.
数据包的首部,明确标明了协议应该如何读取数据.反过来说,看到首部,也就能够了解该协议必要的信息以及所要处理内容
1. 模型中每层的数据单位:
应用层, 表示层, 会话层: 消息
传输层: 段
网络层: 数据报
数据链路层: 帧
物理层: 0/1序列
2. 计算机A向另一台计算机B发送电子邮件的TCP/IP通信的过程
+ 应用层: 启动程序新建邮件, 填写收件人, 内容等等, 直到点击发送按钮
+ 表示层: 汉字按utf-8进行编码
+ 会话层: 编码转化后,实际邮件不一定会马上被发送出去,因为有些邮件的软件有一次同时发送多个邮件的功能,
也可能会有用户点击"收信"按钮以后才一并接收新邮件的功能.建立通信连接何时发送数据的管理功能属于会话层
+ 传输层: TCP模块. TCP根据应用(会话层)的指示,负责建立连接、发送数据以及断开连接.
为了实现TCP的这一功能,需要在应用层数据的前端附加一个TCP首部.
+ + TCP首部中包括源端口号和目标端口号(用以识别发送主机跟接收主机上的应用)、
+ + 序号(用以发送的包中哪部分是数据)以及
+ + 校验和(Check Sum,用来检验数据的读取是否正常进行的方法用以判断数据是否被损坏).
随后将附加了TCP首部的包再发送给IP
+ 网络层 IP模块
IP将TCP传过来的TCP首部和TCP数据合起来当做自己的数据,并在TCP首部的前端在加上自己的IP首部.
因此,IP数据包中IP首部后面紧跟着TCP首部,然后才是应用的数据首部和数据本身.
+ + IP首部中包含接收端IP地址以及发送端IP地址.
+ + 紧随IP首部的还有用来判断其后面数据是TCP还是UDP的信息.
IP包生成后,参考路由控制表决定接受此IP包的路由或主机.
随后,IP包将被发送给连接这些路由器或主机网络接口的驱动程序,以实现真正发送数据.
如果尚不知道接收端的MAC地址,可以利用ARP(AddressResolution Protocol)查找.
只要知道了对端的MAC地址,就可以将MAC地址和IP地址交给以太网的驱动程序,实现数据传输
+ 数据链路层, 网卡(以太网驱动)
给IP层传过来的数据报附加上以太网首部并进行发送处理.
+ + 以太网首部中包含接收端MAC地址、发送端MAC地址
+ + 以及标志以太网类型的以太网数据的协议.
根据上述信息产生的以太网数据包将通过物理层传输给接收端.
+ + 发送处理中的FCS(Frame Check Sequence) 由硬件计算,添加到包的最后
![](images/以太网包结构.png)    
**经过每个协议分层时,都必须有识别包发送端和接收端的信息.**
**以太网会用MAC地址,IP会用IP地址,而TCP/UDP则会用端口号作为识别两端主机的地址.**
**此外,每个分层的包首部中还包含一个识别位,它是用来标识上一层协议的种类信息**
### 数据包接收处理
包的接收流程是发送流程的逆序过程
+ 数据链路层, 网卡(以太网驱动)
+ + 主机收到以太网包以后,首先从以太网的包首部找到MAC地址判断是否为发给自己的包
+ + 是发给自己的包,就查找以太网包首部中的类型域从而确定以太网协议所传送过来的数据类型.
+ + 在这个例子中数据类型显然是IP包,因此再将数据传给处理IP的子程序,
如果这时不是IP而是其他诸如ARP的协议,就把数据传给ARP处理.
总之,如果以太网包首部的类型域包含了一个无法识别的协议类型,则丢弃数据
+ IP模块的处理
+ + 判断包首部中的IP接收端地址是否与自己的IP地址匹配,若是, 则可接收数据并从中查找上一层的协议.
+ + 如果上一层是TCP就将IP包首部之后的部分传给TCP处理；如果是UDP则将IP包首部后面的部分传给UDP处理.
对于有路由器的情况下,接收端地址往往不是自己的地址,
此时,需要借助路由控制表,在调查应该送达的主机或路由器以后再转发数据
+ TCP模块的处理
+ + 在TCP模块中,首先会计算一下校验和,判断数据是否被破坏.
+ + 然后检查是否在按照序号接收数据.最后检查端口号,确定具体的应用程序.
+ + 数据接收完毕后,接收端则发送一个"确认回执"给发送端.
如果这个回执信息未能达到发送端,那么发送端会认为接收端没有接收到数据而一直反复发送.
+ + 数据被完整地接收以后,会传给由端口号识别的应用程序
+ 应用程序的处理
接收端应用程序会直接接收发送端发送的数据.通过解析数据可以获知邮件的收件人地址是乙的地址.
如果主机B上没有接收人的邮件信箱,那么主机B返回给发送端一个"无此收件地址"的报错信息.
如果有, 就接收电子邮件的正文.邮件会被保存到本机的硬盘上.
如果保存也能正常进行,那么接收端会返回一个"处理正常"的回执给发送端.
反之,一旦出现磁盘满、邮件未能成功保存等问题,就会发送一个"处理异常"的回执给发送端.
由此,接收人就可以利用主机B上的邮件客户端,接收并阅读由主机A上的发送用户所发送过来的电子邮件.

### SNS(Social Network Service)
社交网络通信实例,是一种即时共享,即时发布消息给圈内特定联系人的一种服务
移动电话、智能手机、平板电脑等在进行分组数据的通信,
因此在它们装入电池开机的那一刻,已经由通信运营商设定了具体的IP地址.
启动移动电话中的应用程序时,会连接指定的服务器,
经过用户名、密码验证以后服务器上积累的信息就会发送到手机终端上,并由该终端显示具体内容.


## 三 数据链路
### 数据链路的作用
1. 数据链路, 指OSI参考模型中的数据链路层, 有时也指以太网、无线局域网等通信手段.
2. 数据链路层的协议定义了通过通信媒介互连的设备之间传输的规范.
通信媒介包括双绞线电缆、同轴电缆、光纤、电波以及红外线等介质.
此外, 各个设备之间有时也会通过交换机、网桥、中继器等中转数据.
3. 计算机以二进制0、1来表示信息, 然而实际的通信媒介之间处理的却是电压的高低、光的闪灭以及电波的强弱等信号.
把这些信号与二进制的0、1进行转换正是物理层(参考附录3)的责任.
数据链路层处理的数据也不是单纯的0、1序列, 该层把它们集合为一个叫做“帧”的块, 然后再进行传输.
4. OSI参考模型中数据链路层的相关技术, 包括MAC寻址(物理寻址)、介质共享、非公有网络、
分组交换、环路检测、VLAN(Virtual Local Area Network, 虚拟局域网)等.数据链路也可以作为传输方式, 
如以太网、WLAN(Wireless Local AreaNetwork, 无限局域网)、PPP(Point to Point Protocol, 点对点协议)
5. 数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递
### 数据链路相关技术
1. MAC地址
MAC地址用于识别数据链路中互连的节点.
MAC地址长48比特, 
+ 1: 单播地址(0)/多播地址
+ 2: 全局地址(0)/本地地址
+ 3-24: IEEE管理, 保证厂商之间不重复
+ 25- 48: 厂商保证产品不会重复
在使用网卡(NIC)的情况下, MAC地址一般会被烧入到ROM中.
因此, 任何一个网卡的MAC地址都是唯一的, 这是通信协议的前提. 但是开启虚拟机时很难保证MAC的唯一性
2. 共享介质型网络
从通信介质(通信, 介质)的使用方法上看, 网络可分为共享介质型和非共享介质型
有两种介质访问控制方式：一种是争用方式, 另一种是令牌传递方式.
+ 争用方式(Contention)是指争夺获取数据传输的权力, 也叫CSMA(载波监听多路访问)
采用先到先得的方式占用信道发送数据, 如果多个站同时发送帧, 则会产生冲突现象
CSMA/CD, 作为一种CSMA的改良方式, 要求每个站提前检查冲突, 一旦发生冲突, 则尽早释放信道
+ 令牌传递方式
令牌传递方式是沿着令牌环发送一种叫做“令牌”的特殊报文, 是控制传输的一种方式.只有获得令牌的站才能发送数据
因为一个站在没有收到令牌前不能发送数据帧, 因此在网络不太拥堵的情况下数据链路的利用率也就达不到100％.
为此, 衍生了多种令牌传递的技术.例如, 早期令牌释放、令牌追加(不等待接收方的数据到达确认就将令牌发送给下一个站).
3. 非共享介质网络
非共享介质网络是指不共享介质, 是对介质采取专用的一种传输控制方式.主机到交换机的传输介质是专有的.
在这种方式下, 网络中的每个站直连交换机, 由交换机负责转发数据帧.
此方式下, 发送端与接收端并不共享通信介质, 因此很多情况下采用全双工通信方式.
这种方式也有一个致命的弱点, 那就是一旦交换机发生故障, 与之相连的所有计算机之间都将无法通信
+ 半双工: 只发送或只接收的通信方式.它类似于无线电收发器
+ 全双工: 允许在同一时间既可以发送数据也可以接收数据, 类似于电话
4. 根据MAC地址转发
介质共享网络中, 同一时间只能有一台主机发送数据.主机数量增加时, 通信性能会明显下降.
非共享介质网络中集线器或集中器等设备以星型连接, 就出现了一款新的网络设备——交换集线器, 以太网中也叫做以太网交换机
+ 以太网交换机就是持有多个外部接口的网桥(它能够识别数据链路层中的数据帧, 并将这些数据帧临时存储于内存, 
再重新生成信号作为一个全新的帧转发给相连的另一个网段).它们根据数据链路层中每个帧的目标MAC地址, 决定从哪个
网络接口发送数据.这时所参考的、用以记录发送接口的表就叫做转发表(Forwarding Table)
+ 数据链路层的每个通过点在接到包时, 会从中将源MAC地址以及曾经接收该地址发送的数据包的接口作为对应关系记录
到转发表中. 转发表通过上面的自学过程, 建立MAC地址和以太网交换机接口的映射
+ 当连接多个终端时, 有必要将网络分成多个数据链路, 采用类似于网络层的IP地址一样对地址进行分层管理
+ 交换机转发方式
+ + 一种叫存储转发: 存储转发方式检查以太网数据帧末尾的FCS位后再进行转发, 可避免发送无效的帧
+ + 另一种叫直通转发: 只需要得知目标地址即可开始转发.因此, 它具有延迟较短的优势.
5. 环路检测技术
通过网桥连接网络时, 出现的环路与网络的拓扑结构和所使用的网桥种类有直接关系
解决网络中的环路问题, 具体有生成树与源路由两种方式. 这两种方式内置在网桥中
+ 生成树方式
每个网桥必须在每1～10秒内相互交换BPDU(Bridge Protocol Data Unit)包, 从而判断哪些端口使用哪些不使用, 以便消除环路.
+ 源路由法
源路由法最早由IBM提出, 以解决令牌环网络的问题.
该方式可以判断发送数据的源地址是通过哪个网桥实现传输的, 并将帧写入RIF(Routing InformationField).
网桥则根据这个RIF信息发送帧给目标地址.因此, 即使网桥中出现了环路, 数据帧也不会被反复转发, 可成功地发送到目标地址.
在这种机制中发送端本身必须具备源路由的功能
6. VLAN(Virtual LAN)
VLAN是交换机按照其端口区分了多个网段, 从而区分了广播数据传播的范围、减少了网络负载并提高了网络的安全性.
然而异构的两个网段之间, 就需要利用具有路由功能的交换机(如3层交换机), 或在各段中间通过路由器的连接才能实现通信.
作用: 带有VLAN技术的网桥, 就不用实际修改网络布线, 只需修改网络的结构即可.
VLAN技术附加到网桥/2层交换上, 可以过滤多余的包, 提高网络的承载效率

### 以太网(Ethernet)
1. 历史
起初以太网的访问控制一般以半双工通信为前提采用CSMA/CD方式,因为要做冲突检查, 此时网速较慢
随着ATM交换技术(ATM中将固定长度的信元通过交换机快速传送) 的进步和CAT5 UTP电缆的普及很快就被打破.
以太网的结构也发生了变化, 逐渐采用像共享介质网络那样直接与交换机连接的方式.
于是, 冲突检查不再是必要内容, 网络变得更加高速
2. 以太网帧格式
以太网帧本体的前端是以太网的首部, 它总共占14个字节.分别是6个字节的目标MAC地址、6个字节的源MAC地址以及2个字节的上层协议类型.
紧随帧头后面的是数据.一个数据帧所能容纳的最大数据范围是46～1500个字节.
帧尾是一个叫做FCS(Frame Check Sequence, 帧检验序列)的4个字节用FCS可以检查帧是否有所损坏
数据链路层分为介质访问控制层(介质访问控制层简称MAC(Media Access Control)) 
和逻辑链路控制层(逻辑链路控制层简称LLC(Logical Link Control)) 
介质访问控制层根据以太网或FDDI(Fiber Distributed Data Interface, 光纤分布式数据接口)等不同数据链路所特有的首部信息进行控制.
与之相比, 逻辑链路层则根据以太网或FDDI等不同数据链路所共有的帧头信息进行控制
### 其他数据链路
1. 无线通信
无线PAN(Personal Area Network) (802.15), 蓝牙
无线LAN(Local Area Network) (802.11), wifi
无线MAN(MetropolitanArea Network) (802.16)
无线RAN(Regional Area Network)(802.22)
无线WAN(Wide Area Network), 3G, 4G, 手机通信.手机通过基站能够实现长距离通信
2. PPP
PPP(Point-to-Point Protocol)是指点对点, 即1对1连接计算机的协议.PPP相当于位于OSI参考模型第2层的数据链路层.
PPP属于纯粹的数据链路层, 与物理层没有任何关系.换句话说, 仅有PPP无法实现通信, 还需要有物理层的支持.
PPP可以使用电话线或ISDN、专线、ATM线路
3. PPPoE(PPP over Ethernet)
有些互联网接入服务商在以太网上利用PPPoE(PPP over Ethernet)提供PPP功能
4. ATM
ATM(Asynchronous Transfer Mode)是以一个叫做信元(5字节首部加48字节数据)的单位进行传输的数据链路, 
+ 由于其线路占用时间短和能够高效传输大容量数据等特点主要用于广域网络的连接.
+ ATM是面向连接的一种数据链路.因此在进行通信传输之前一定要设置通信线路.这一点与传统电话很相似.
+ 而ATM又与传统电话不同, 它允许同时与多个对端建立通信连接
+ ATM中没有类似以太网和FDDI那种发送权限的限制.它允许在任何时候发送任何数据
+ 但是在全部的信元中只要有一个丢失, 那么整个IP包就相当于被损坏, 接收端不得不丢弃所有的信元
![在这里插入图片描述](images/ATM信元.png)    
**同步与异步**
多个通信设备通过一条电缆相连的情况为例
4.1. 同步, 连接的设备叫做TDM(时分复用设备)
TDM通常在两端TDM设备之间同步的同时, 按照特定的时间将每个帧分成若干个时隙, 按照顺序发送给目标地址
4.2. 异步
ATM扩展了TDM, 能够有效地提高线路的利用率
(采用TDM方式的SONET(Synchronous Optical Network)或SDH(Sychro-nous Digital Hierachy)的线路) 
+ ATM在TDM的时隙中放入数据时, 并非按照线路的顺序而是按照数据到达的顺序放入.
+ 然而, 按照这样的顺序存放的数据在接收端并不易辨认真正的内容.为此, 发送端还需要附加一个5字节的包首部, 包含
VPI(Virtual Path Identifier)、VCI(Virtual Channel Identifier)等识别码(在VPI所标识的通信线路中, 用VCI识别多个通信) 
+ 这种VPI与VCI的值只在直连通信的两个ATM交换机之间设置.在其他交换机之间意思则完全不同.
ATM中信元传输所占用的时隙不固定, 一个帧所占用的时隙数也不固定, 而且时隙之间并不要求连续
5. FDDI
FDDI(Fiber Distributed Data Interface)叫做分布式光线数据接口.
FDDI采用令牌(追加令牌)环的访问方式.令牌环访问方式在网络拥堵的情况下极容易导致网络收敛
6. 光纤通道
光纤通道(Fiber Channel)是实现高速数据通信的一种数据链路.数据传输速率为133Mbpx～4Gbps
与其说它是一种网络, 不如说它更像是SCSI那样类似于连接计算机周边设备的总线一样的规范
7. HDMI
HDMI是High-Definition Multimedia Interface的缩写, 意为高清晰度多媒体接口.
它可以通过一根缆线实现图像和声音等数字信号的高品质传输.
从2009年发布的1.4版开始它可以传输以太网帧, 使得采用HDMI介质实现TCP/IP通信变为可能
8. VPN
虚拟专用网络(VPN)用于连接距离较远的地域.这种服务包括IP-VPN和广域以太网
+ IP-VPN
意指在IP网络(互联网)上建立VPN.网络服务商提供一种在IP网络上使用MPLS技术构建VPN的服务.
其中MPLS(Multiprotocol Label Switching, 多协议标签交换)在IP包中附加一个叫做标签(Label(有时也叫tag))的信息进行传输控制
+ 广域以太网
服务提供商所提供的用于连接相距较远的地域的一种服务.
IPVPN是在IP层面的连接, 广域以太网则是在作为数据链路层的以太网上利用VLAN(虚拟局域网)实现VPN的技术.

## 四 IP协议
IP(Internet Protocol, 网际协议)
IP作为整个TCP/IP中至关重要的协议, 主要负责将数据包发送给最终的目标计算机.因此, IP能够让世界上任何两台计算机之间进行通信
### 网络层
IP(IPv4、IPv6)相当于OSI参考模型中的第3层——网络层
1. 网络层的主要作用是“实现终端节点之间的通信”.这种终端节点之间的通信也叫“点对点(end-to-end)通信
2. 数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递.
而一旦跨越多种数据链路, 就需要借助网络层.网络层可以跨越不同的数据链路, 即使是在不
同的数据链路上也能实现两端节点之间的数据包传输
3. 数据链路层提供直连两个设备之间的通信功能.与之相比, 作为网络层的IP则负责在没有直连的两个网络之间进行通信传输
没有IP层提供进行通信传输控制, 数据链路层虽然可以直连两个设备, 也很难知道该传输什么, 怎么传输
**主机与节点**
+ 主机的定义应该是指“配置有IP地址, 但是不进行路由控制(路由控制英文叫做Routing.是指中转分组数据包) 的设备
+ 节点则是主机和路由器的统称, 既配有IP地址又具有路由控制能力的设备叫做“路由器”
### IP基础知识
IP大致分为三大作用模块, 它们是IP寻址、路由(最终节点为止的转发)以及IP分包与组包
1. IP寻址
IP地址用于在“连接到网络中的所有主机中识别出进行通信的目标地址”.
因此, 在TCP/IP通信中所有主机或路由器必须设定自己的IP地址, 数据链路的类型对IP地址形式透明
严格来说, 要针对每块网卡至少配置一个或一个以上的IP地址.
网桥或交换集线器等物理层或数据链路层数据包转发设备中, 不需要设置IP地址
2. 路由控制
路由控制(Routing)是指将分组数据发送到最终目标地址的功能. 即使网络非常复杂, 也可以通过路由控制确定到达目标地址的通路
+ 发送数据至最终目标地址
Hop译为中文叫“跳”.它是指网络中的一个区间.IP包正是在网络中一个个跳间被转发.在每一个区间内决定着包在下一跳被转发的路径.
+ 一跳(1 Hop)是指利用数据链路层以下分层的功能传输数据帧的一个区间
以太网等数据链路中使用MAC地址传输数据帧.此时的一跳是指从源MAC地址到目标MAC地址之间传输帧的区间.
也就是说它是主机或路由器网卡不经其他路由器而能直接到达的相邻主机或路由器网卡之间的一个区间.
+ 多跳路由是指路由器或主机在转发IP数据包时只指定下一个路由器或主机, 而不是将到最终目标地址为止的所有通路全都指定出来.
因为每一个区间(跳)在转发IP数据包时会分别指定下一跳的操作, 直至包达到最终的目标地址
+ 当某个IP包到达路由器时, 路由器首先查找其目标地址(IP包被转发到途中的某个路由器时, 实际上是装入数据链路层
的数据帧以后再被送出.以以太网为例, 目标MAC地址就是下一个路由器的MAC地址), 
从而再决定下一步应该将这个包发往哪个路由器, 然后将包发送过去
+ 路由控制表
为了将数据包发给目标主机, 所有主机都维护着一张路由控制表(Routing Table).
该表记录IP数据在下一步应该发给哪个路由器.IP包将根据这个路由表在各个数据链路上传输
3. 数据链路的抽象化
不同数据链路有个最大的区别, 就是它们各自的最大传输单位(MTU：Maximum Transmission Unit)不同
MTU的值在以太网中是1500字节, 在FDDI中是4352字节, 而ATM则为9180字节.
+ IP的上一层可能会要求传送比这些MTU更多字节的数据, 因此必须在线路上传送比包长还要小的MTU.
为了解决这个问题, IP进行分片处理(IP Fragmentation).顾名思义, 所谓分片处理是指, 将较大的IP包分成多个较小的IP包
分片的包到了对端目标地址以后会再被组合起来传给上一层
4. IP属于面向无连接型
IP面向无连接.即在发包之前, 不需要建立与对端目标地址之间的连接.
上层如果遇到需要发送给IP的数据, 该数据会立即被压缩成IP包发送出去
+ IP为了实现简单化与高速化采用面向无连接的方式
面向连接比起面向无连接处理相对复杂.甚至管理每个连接本身就是一个相当繁琐的事
情.此外, 每次通信之前都要事先建立连接, 又会降低处理速度
+ 为了提高可靠性, 上一层的TCP采用面向有连接型
IP提供尽力服务(Best Effort), 意指“为了把数据包发送到最终目标地址, 尽最大努力.”
然而, 它并不做“最终收到与否的验证”.IP数据包在途中可能会发生丢包、错位以及数据量翻倍等问题
TCP保证通信的可靠性.如果说IP只负责将数据发给目标主机, 那么TCP则负责保证对端主机确实接收到数据.
### IP地址的基础知识
在用TCP/IP通信时, 用IP地址识别主机和路由器.为了保证正常通信, 有必要为每个设备配置正确的IP地址.
在互联网通信中, 全世界都必须设定正确的IP地址.否则, 根本无法实现正常的通信.
|| 2^8 | 2^8 | 2^8 | 2^8 |
|--| -- | -- | -- | -- |
|2进制| 1010 1100 | 0001 0100 | 0000 0001 | 0000 0001 |
|10进制| 172. | 20. | 1. | 1. |
1. IP地址的定义
IP地址(IPv4地址)由32位正整数来表示.TCP/IP通信要求将这样的IP地址分配给每一个参与通信的主机.
IP地址在计算机内部以二进制(二进制是指用0、1表示数字的方法) 方式被处理.
然而, 由于人类社会并不习惯于采用二进制方式, 需要采用一种特殊的标记方式.
那就是将32位的IP地址以每8位为一组, 分成4组, 每组以“.”隔开, 再将每组数转换为十进制数
IP地址并非是根据主机台数来配置的, 而是每一台主机上的每一块网卡(NIC)都得设置IP地址
2. IP地址由网络和主机两部分标识组成
+ IP地址由“网络标识(网络地址)”和“主机标识(主机地址)”两部分组成
192.168.128.10/24中的“/24”表示从第1位开始到多少位属于网络标识.192.168.128之前的都是该IP的网络地址
+ IP地址唯一性
唯一性是指在整个网络中, 不会跟其他主机的IP地址冲突
通过设置网络地址和主机地址, 在相互连接的整个网络中保证每台主机的IP地址都不会相互重叠
如何确定网络标识: 基本以子网掩码(网络前缀)区分
3. IP地址的分类
根据IP地址中从第1位到第4位的比特列对其网络标识和主机标识进行区分, 
IP地址分为四个级别, 分别为A类、B类、C类、D类(还有一个一直未使用的E类)
+ 注意.用比特位表示主机地址时, 不可以全部为0或全部为1.
因为全部为只有0在表示对应的网络地址或IP地址不可获知的情况下才使用.
而全部为1的主机地址通常作为广播地址
+ A类地址 
**A类IP地址是首位以“0”开头的地址.从第1位到第8位(去掉分类位剩下7位)** 是它的网络标识
用十进制表示的话, 0.0.0.0～127.0.0.0是A类的网络地址
主机地址上限为2^24 -2 , 
+ B类地址
**B类IP地址是前两位为“10”的地址.从第1位到第16位(去掉分类位剩下14位)** 是它的网络标识.
用十进制表示的话, 128.0.0.1～191.255.0.0是B类的网络地址.
主机地址上限为2^16 -2: 65, 534个
+ C类地址
**C类IP地址是前三位为“110”的地址.从第1位到第24位(去掉分类位剩下21位)** 是它的网络标识.
用十进制表示的话, 192.168.0.0～239.255.255.0是C类的网络地址.
C类地址的后8位相当于主机标识.因此, 一个网段内可容纳的主机地址上限为254: 2^7 -2个
+ D类地址
**D类IP地址是前四位为“1110”的地址.从第1位到第32位(去掉分类位剩下28位)** 是它的网络标识.
用十进制表示的话, 224.0.0.0～239.255.255.255是D类的网络地址.
D类地址没有主机标识, 常被用于多播.
![](images/IP地址分类.png)    
4. 广播地址
广播地址用于在同一个链路中相互连接的主机之间发送数据包.
**将IP地址中的主机地址部分全部设置为1, 就成为了广播地址**
(以太网中如果将MAC地址的所有位都改为1, 则形成FF：FF：FF：FF：FF：FF的广播地址.
因此, 广播的IP包以数据链路的帧的形式发送时, 得通过MAC地址为全1比特的FF：FF：FF：FF：FF：FF转发.
+ 广播分为本地广播和直接广播两种.
+ + 在本网络内的广播叫做本地广播.例如网络地址为192.168.0.0/24的情况下, 广播地址是192.168.0.255.
因为这个广播地址的IP包会被路由器屏蔽, 所以不会到达192.168.0.0/24以外的其他链路上.
+ + 在不同网络之间的广播叫做直接广播.例如网络地址为192.168.0.0/24的主机向192.168.1.255/24的目标地址发送IP包.
**收到这个包的路由器, 将数据转发给192.168.1.0/24, 从而使得所有192.168.1.1～192.168.1.254的主机都能收到这个包**
(由于直接广播有一定的安全问题, 多数情况下会在路由器上设置为不转发)
5. IP多播
对于向多台主机同时发送数据包. 广播将数据发给所有终端主机, 这会给不相关的网络带来影响, 而且广播不能穿透路由.
针对这种情况, 多播这种既可以穿透路由器, 又可以实现只给那些必要的组发送数据包的技术就成为必选之路.
+ 同时发送提高效率
多播用于将包发送给特定组内的所有主机.由于其直接使用IP协议, 因此也不存在可靠传输.
+ IP多播与地址
**多播使用D类地址.因此, 如果从首位开始到第4位是“1110”, 就可以认为是多播地址**.而剩下的28位可以成为多播的组编号.
从224(2^7+2^6+2^5+0*2^4).0.0.0到239.255.255.255都是多播地址的可用范围.
其中从224.0.0.0到224.0.0.255的范围不需要路由控制, 在同一个链路内也能实现多播.
而在这个范围之外设置多播地址会给全网所有组内成员发送多播的包(利用生存时间(TTL, Time To Live)限制包的到达范围).
此外, 对于多播, 所有的主机(路由器以外的主机和终端主机)必须属于224.0.0.1的组, 所有的路由器必须属于224.0.0.2的组.
利用IP多播实现通信, 除了地址外还需要IGMP(Internet GroupManagement Protocol) 等协议的支持
6. 子网与子网掩码
IP地址只要确定了其分类, 也就确定了它的网络标识和主机标识, A类,B类地址下主机地址太多, 直接使用造成了浪费, 
为解决这种情况, 通过一个叫做“子网掩码”的识别码通过子网网络地址细分出比A类、B类、C类更小粒度的网络.
这种方式实际上就是将原来A类、B类C类等分类中的主机地址部分用作子网地址, 可以将原网络分为多个物理网络的一种机制.
引入了子网以后, 一个IP地址就有了两种识别码.一是IP地址本身, 另一个是表示网络部的子网掩码.
+ 子网掩码用二进制方式表示的话, 也是一个32位的数字.
它对应IP地址网络标识部分的位全部为“1”, 对应IP地址主机标识的部分则全部为“0”.
由此, 一个IP地址可以不再受限于自己的类别, 而是可以用这样的子网掩码自由地定位自己的网络标识长度.
当然, 子网掩码必须是IP地址的首位开始连续的“1”
7. CIDR与VLSM
+ CIDR(无类型域间选路): 采用任意长度分割IP地址的网络标识和主机标识的方式
由于BGP(Border Gateway Protocol, 边界网关协议)对应了CIDR, 
所以不受IP地址分类的限制自由分配(Classless Inter-Domain Routing) 
CIDR更有效地利用了当前IPv4地址, 同时通过路由集中降低了路由器的负担
+ VLSM(可变长子网掩码): 可以随机修改组织内各个部门的子网掩码长度的机制
8. 全局地址与私有地址
目的是为了解决IP地址不足的问题
+ 全局IP地址基本上要在整个互联网范围内保持唯一, 但私有地址不需要.
    只要在同一个域里保证唯一即可.在不同的域里出现相同的私有IP不会影响使用
私有IP最早没有计划连接互联网, 而只用于互联网之外的独立网络.
然而, 当一种能够互换私有IP与全局IP的NAT技术诞生以后, 配有私有地址的主机与配有全局地址的互联网主机实现了通信    
+ 私有IP地址结合NAT技术已成为现在解决IP地址分配问题的主流方案, 它与使用全局IP地址相比有各种限制
(例如在应用的首部或数据部分传递IP地址和端口号的应用程序来说, 直接使用私有地址会导致无法通信)
+ IPv6
### 路由控制
发送数据包时所使用的地址是网络层的地址, 即IP地址.然而仅仅有IP地址还不足以实现将数据包发送到对端目标地址, 
在数据发送过程中还需要类似于“指明路由器或主机”的信息, 以便真正发往目标地址.
保存这种信息的就是路由控制表(Routing Table).实现IP通信的主机和路由器都必须持有一张这样的表.
它们也正是在这个表格的基础上才得以进行数据包发送的.该表是由一个叫做“路由协议”(这个协议有别于IP)的协议制作而成
该路由控制表的形成方式有两种：一种是管理员手动设置, 另一种是路由器与其他路由器相互交换信息时自动刷新.
前者也叫静态路由控制, 而后者叫做动态路由控制.　
1. IP地址与路由控制
路由控制表中记录着网络地址与下一步应该发送至路由器的地址(netstat)
+ 在发送IP包时, 首先要确定IP包首部中的目标地址, 
+ 再从路由控制表中找到与该地址具有相同网络地址的记录, 
+ 根据该记录将IP包转发给相应的下一个路由器.
如果路由控制表中存在多条相同网络地址的记录, 就选相同位数最多的(最长匹配)
+ 默认路由(default)
指路由表中任何一个地址都能与之匹配的记录.
默认路由一般标记为0.0.0.0/0或default(表示子网掩码时, IP地址为0.0.0.0, 子网掩码也是0.0.0.0)
这里的0.0.0.0/0并不是指IP地址是0.0.0.0.由于后面是“/0”, 所以并没有标识IP地址(IP地址应该记述为0.0.0.0/32)
+ 主机路由
“IP地址/32”也被称为主机路由(Host Route).
例如, 192.168.153.15/32(表示子网掩码时, 若IP地址为192.168.153.15, 其对应的子网掩码为255.255.255.255)
主机路由多被用于不希望通过网络地址路由的情况
(不过, 请读者注意, 使用主机路由会导致路由表膨大, 路由负荷增加, 进而造成网络性能下降)
+ 环回地址
环回地址是在同一台计算机上的程序之间进行网络通信时所使用的一个默认地址.
计算机使用一个特殊的IP地址127.0.0.1作为环回地址.与该地址具有相同意义的是一个叫做localhost的主机名
2. 路由控制表的聚合
路由表的聚合也叫路由汇总(Aggregation)
利用网络地址的比特分布可以有效地进行分层配置.对内即使有多个子网掩码, 对外呈现出的也是同一个网络地址
能够缩小路由表的大小是它最大的优势
![](images/路由汇总.png)    
### IP分割处理与再构成处理
1. 数据链路不同, MTU则相异
每种数据链路的最大传输单元(MTU)都不尽相同, 以太网的默认MTU是1500字节
2. IP报文的分片与重组
+ 由于以太网的默认MTU是1500字节, 因此4342字节的IP数据报无法在一个帧当中发送完成.
这时, 路由器将此IP数据报划分成了3个分片进行发送.而这种分片处理只要路由器认为有必要, 会周而复始地进行
(分片以8个字节的倍数为单位进行)
+ 经过分片之后的IP数据报在被重组的时候, 只能由目标主机进行.路由器虽然做分片但不会进行重组
这样处理的原因: 
+ + 现实当中无法保证IP数据报是否经由同一个路径传送
+ + 拆分之后的每个分片也有可能会在途中丢失
+ + 即使在途中某一处被重新组装, 但如果下一站再经过其他路由时还会面临被分片的可能 
+ + 降低网络传送效率
3. 路径MTU发现
+ 分片机制也有它的不足
+ + 路由器的处理负荷加重
+ + 计算机网络的物理传输速度不断上升
+ + 路由器需要做的其他处理也越来越多, 如网络过滤
+ + 分片处理中, 一旦某个分片丢失, 则会造成整个IP数据报作废
为了应对分片机制的不足, 产生了一种新的技术“路径MTU发现”(Path MTU Discovery(也可以缩写为PMTUD)
+ 路径MTU(PathMTU)
指从发送端主机到接收端主机之间不需要分片时的最大MTU的大小.
即路径中存在的所有数据链路中最小的MTU.而路径MTU发现从发送主机按照路径MTU的大小将数据报分片后进行发送.
进行路径MTU发现, 就可以避免在中途的路由器上进行分片处理, 也可以在TCP中发送更大的包.
UDP
1. 首先在发送端主机发送IP数据报时将其首部的分片禁止标志位设置为1, 大于路径MTU的包被丢弃
2. ICMP(不可达消息)通知下一次MTU的大小
3. UDP没有重发处理, 发送主机根据ICMP中的MTU对数据报进行分片处理, 直到没有ICMP.
*UDP层传到IP层的"UDP首部+UDP数据"被IP层分片, 对IP层, 它不区分首部和应用数据*
4. 所有分片到达目标主机后, 被重组, 传给UDP层
TCP
1. 首先在发送端主机发送IP数据报时将其首部的分片禁止标志位设置为1, 大于路径MTU的包被丢弃
2. ICMP(不可达消息)通知下一次MTU的大小
3. TCP有重发处理, 发送主机根据ICMP中的MTU对数据报进行分片处理, 直到没有ICMP.
*TCP层会将数据分成IP层不会再分片的粒度, 然后传给IP层. IP层不会再做分片处理*
4. 所有分片到达目标主机后, 被重组, 传给TCP层
### IPv6
1. IPv6的必要性
IPv6(IP version 6)是为了根本解决IPv4地址耗尽的问题而被标准化的网际协议.
IPv4的地址长度为4个8位字节, 即32比特.而IPv6的地址长度则是原来的4倍, 即128比特(因此IPv6的地址空间是IPv4的2^96倍)
一般写成8个16位字节
2. IPv6的特点
+ IP地址的扩大与路由控制表的聚合
IP地址依然适应互联网分层构造.分配与其地址结构相适应的IP地址, 尽可能避免路由表膨大.
+ 性能提升
包首部长度采用固定的值(40字节), 不再采用首部检验码.简化首部结构, 减轻路由器负荷.
路由器不再做分片处理(通过路径MTU发现只由发送端主机进行分片处理).
+ 支持即插即用功能
即使没有DHCP服务器也可以实现自动分配IP地址.
采用认证与加密功能应对伪造IP地址的网络安全功能以及防止线路窃听的功能(IPsec).
+ 多播、Mobile IP成为扩展功能
多播和Mobile IP被定义为IPv6的扩展功能.由此可以预期, 曾在IPv4中难于应用的这两个功能在IPv6中能够顺利使用.
3. IPv6的IP地址标记举例
用二进制数表示
1111111011011100：1011101010011000：0111011001010100：
0011001000010000：1111111011011100：1011101010011000：
0111011001010100：0011001000010000
用十六进制数表示
FEDC：BA98：7654：3210：FEDC：BA98：7654：3210
IPv6的IP地址省略举例
+ 用二进制数表示
0001000010000000：0000000000000000：0000000000000000：
0000000000000000：0000000000000000：0000100000000000：
0010000000001100：0100000101111010
用十六进制数表示
1080:0:0:0:8:800:200C:417A  =省略0=
1080::8:800:200C:417A
4. IPv6地址的结构
IPv6类似IPv4, 也是通过IP地址的前几位标识IP地址的种类.
+ 在互联网通信中, 使用一种全局的单播地址.它是互联网中唯一的一个地址, 不需要正式分配IP地址.
    即前64比特为网络标识, 后64比特为主机标识
+ 限制型网络, 即那些不与互联网直接接入的私有网络, 可以使用唯一本地地址.
+ 在不使用路由器或者在同一个以太网网段内进行通信时, 可以使用链路本地单播地址.
+ 而在构建允许多种类型IP地址的网络时, 在同一个链路上也可以使用全局单播地址以及唯一本地地址进行通信.
在IPv6的环境下, 可以同时将这些IP地址全都配置在同1个NIC上, 按需灵活使用.
8. IPv6分段处理
IPv6的分片处理只在作为起点的发送端主机上进行, 路由器不参与分片.这也是为了减少路由器的负荷, 提高网速.
IPv6中最小MTU为1280字节
### IP首部
IPv4首部![IPv4首部](images/IPv4首部.png)    
IPv6首部![IPv6首部](images/IPv6首部.png)    

## 五 IP协议相关技术
IP(Internet Protocol)旨在让最终目标主机收到数据包, 但是在这一过程中仅仅有IP是无法实现通信的.
必须还有能够解析主机名称和MAC地址的功能, 以及数据包在发送过程中异常情况处理的功能.
此外, 还会涉及IP必不可少的其他功能, 包括DNS、ARP、ICMP以及DHCP等协议.
### DNS(Domain Name System)
我们平常在访问某个网站时不使用IP地址, 而是用一串由罗马字和点号组成的字符串.
DNS可以将那串字符串自动转换为具体的IP地址.
1. TCP/IP世界中从一开始就已经有了一个叫做主机识别码的东西.
这种识别方式是指为每台计算机赋以唯一的主机名, 在进行网络通信时可以直接使用主机名称而无需输入一大长串的IP地址.
并且此时, 系统必须自动将主机名转换为具体的IP地址.为了实现这样的功能, 主机往往会利用一个叫做hosts的数据库文件.
2. 因为主机越来越多, 就产生了可以有效管理主机名和IP地址之间对应关系的系统, 那就是DNS系统
当用户输入主机名(域名)时, DNS会自动检索那个注册了主机名和IP地址的数据库, 并迅速定位对应的IP地址
**nslookup sjgo.online**
3. 域名的构成
域名是指为了识别主机名称和组织机构名称的一种具有分层的名称: www.baidu.com
在启用域名功能之前, 单凭主机名还无法完全管理IP地址, 因为在不同的组织机构中不允许有同名的主机.
然而, 当出现了带有层次结构的域名之后, 每一个组织机构就可以自由地为主机命名了
+ 域名服务器是指管理域名的主机和相应的软件, 它可以管理所在分层的域的相关信息.其所管理的分层叫做ZONE
+ 根部所设置的DNS叫做根域名服务器.它对DNS的检索数据功能起着至关重要的作用
(根据DNS协议, 根域名服务器可由13个IP地址表示, 并且从A到M开始命名)
+ 所有的域名服务器都必须注册根域名服务器的IP地址
+ 解析器(Resolver)进行DNS查询的主机和软件叫做DNS解析器
4. DNS查询
解析器为了调查IP地址, 向域名服务器(不仅可以访问同一域中的域名服务器, 还可以访问其他域的域名服务器)进行查询处理.
接收这个查询请求的域名服务器首先会在自己的数据库进行查找.
如果有该域名所对应的IP地址就返回.如果没有, 则域名服务器再向上一层根域名服务器进行查询处理
从根开始对这棵树按照顺序进行遍历, 直到找到指定的域名服务器, 并由这个域名服务器返回想要的数据
解析器和域名服务器将最新了解到的信息暂时保存在缓存
5. DNS如同互联网中的分布式数据库
管理的信息不仅仅是这些主机名跟IP地址之间的映射关系.它还要管理众多其他信息
### ARP
ARP(Address Resolution Protocol) 是一种解决地址问题的协议.实际通信时有必要了解每个IP地址所对应的MAC地址
以目标IP地址为线索, 用来定位下一个应该接收数据分包的网络设备对应的MAC地址
如果目标主机不在同一个链路上时, 可以通过ARP查找下一跳路由器的MAC地址.
不过ARP只适用于IPv4, 不能用于IPv6.IPv6中可以用ICMPv6替代ARP发送邻居探索消息
1. ARP的工作机制
ARP是借助ARP请求与ARP响应两种类型的包确定MAC地址的.
从一个IP地址通过广播发送ARP请求包以了解其MAC地址(ARP请求包还有一个作用, 那就是将自己的MAC地址告诉给对方) , 
这个包中包含了想要了解其MAC地址的主机IP地址.
由于广播的包可以被同一个链路上所有的主机或路由器接收, 因此ARP的请求包就会被这同一个链路上所有的主机和路由器进行解析.
目标地址将自己的MAC地址填入其中的ARP响应包返回到IP地址.由此, 可以通过ARP从IP地址获得MAC地址, 实现链路内的IP通信.
+ ARP表
如果每发送一个IP数据报都要进行一次ARP请求以此确定MAC地址, 那将会造成不必要的网络流量, 
因此, 通常的做法是把获取到的MAC地址缓存一段时间.
即把第一次通过ARP获取到的MAC地址作为IP对MAC的映射关系记忆, 记录IP地址与MAC地址对应关系的数据库叫做ARP表
**arp -a**
+ RARP
RARP(Reverse Address Resolution Protocol)是将ARP反过来, 从MAC地址定位IP地址的一种协议
DHCP(Dynamic Host Configuration Protocol, DHCP可以像RARP一样分配一个固定的IP地址) 自动分配获取IP地址
然而, 对于使用嵌入式设备时, 会遇到没有任何输入接口或无法通过DHCP动态获取IP地址的情况
在类似情况下, 就可以使用RARP.为此, 需要架设一台RARP服务器, 
从而在这个服务器上注册设备的MAC地址及其IP地址(使用RARP的前提是认为MAC地址就是设备固有的一个值)
2. 代理ARP(Proxy ARP)
通常ARP包会被路由器隔离, 但是采用代理ARP(Proxy ARP)的路由器可以将ARP请求转发给邻近的网段

### ICMP(Internet Control Message Protocol)
架构IP网络时需要特别注意两点：确认网络是否正常工作, 以及遇到异常时进行问题诊断, CMP正是提供这类功能的一种协议
ICMP的主要功能包括, 确认IP包是否成功送达目标地址, 通知在发送过程当中IP包被废弃的具体原因, 改善网络设置等
+ ICMP的消息大致可以分为两类：一类是通知出错原因的错误消息, 另一类是用于诊断的查询消息
1. 主要的ICMP消息
+ ICMP目标不可达消息(类型3)
IP路由器无法将IP数据包发送给目标地址时, 会给发送端主机返回一个
目标不可达(Destination Unreachable Message)的ICMP消息, 并在这个消息中显示不可达的具体原因
+ ICMP重定向消息(类型5)
如果路由器发现发送端主机使用了次优的路径发送数据, 那么它会返回一个
ICMP重定向(ICMP Redirect Message)的消息给这个主机.在这个消息中包含了最合适的路由信息和源数据
+ ICMP超时消息(类型11)
IP包中有一个字段叫做TTL(Time To Live, 生存周期), 它的值随着每经过一次路由器就会减1, 
直到减到0时该IP包会被丢弃.此时, IP路由器将会发送一个ICMP超时的消息(ICMP Time Exceeded Message, 
错误号0(错误号1表示将被拆分包做重构处理时超时))给发送端主机, 并通知该包已被丢弃
+ + 方便易用的traceroute
有一款充分利用ICMP超时消息的应用叫做traceroute(而在Windows中对等的命令叫做tracert)
**traceroute 目标主机地址**
+ ICMP回送消息(类型0、8)
用于进行通信的主机或路由器之间, 判断所发送的数据包是否已经成功到达对端的一种消息.
可以向对端主机发送回送请求的消息(ICMP Echo Request Message, 类型8), 
也可以接收对端主机发回来的回送应答消息(ICMP Echo Reply Message, 类型0)
网络上最常用的ping命令(Packet InterNetwork Groper, 判断对端主机是否可达) 就是利用这个消息实现的
+ ICMP原点抑制消息(类型4)
在使用低速广域线路的情况下, 连接WAN的路由器可能会遇到网络拥堵的问题.
ICMP原点抑制消息的目的就是为了缓和这种拥堵情况.当路由器向低速线路发送数据时, 其发送队列的残存变为零而无法
发送出去时, 可以向IP包的源地址发送一个ICMP原点抑制(ICMPSource Quench Message)消息.
收到这个消息的主机借此了解在整个线路的某一处发生了拥堵的情况, 从而打开IP包的传输间隔.然而, 由于
这种ICMP可能会引起不公平的网络通信, 一般不被使用.
+ ICMP路由器探索消息(类型9、10)
主要用于发现与自己相连网络中的路由器.当一台主机发出ICMP路由器请求(Router Solicitaion, 类型10)时, 
路由器则返回ICMP路由器公告消息(Router Advertisement, 类型9)给主机.
+ ICMP地址掩码消息(类型17、18)
主要用于主机或路由器想要了解子网掩码的情况.
2. ICMPv6
+ ICMPv6的作用
IPv4中ICMP仅作为一个辅助作用支持IPv4.也就是说, 在IPv4时期, 即使没有ICMP, 仍然可以实现IP通信.
然而, 在IPv6中, ICMP的作用被扩大, 如果没有ICMPv6, IPv6就无法进行正常通信.
尤其在IPv6中, 从IP地址定位MAC地址的协议从ARP转为ICMP的邻居探索消息(Neighbor Discovery).
这种邻居探索消息融合了IPv4的ARP、ICMP重定向以及ICMP路由器选择消息等功能于一体, 甚至还提供自动设置IP地址的功能
(ICMPv6中没有DNS服务器的通知功能, 因此实际上需要与DHCPv6组合起来才能实现自动设置IP地址)
+ ICMPv6中将ICMP大致分为两类：一类是错误消息, 另一类是信息消息.
类型0～127属于错误消息, 128～255属于信息消息.
+ 邻居探索
ICMPv6中从类型133至类型137的消息叫做邻居探索消息.
邻居请求消息用于查询IPv6的地址与MAC地址的对应关系, 并由邻居宣告消息得知MAC地址(IPv4用到的是ARP)
邻居请求消息利用IPv6的多播地址(D类地址)(IARP采用广播, 使得不支持ARP的节点也会收到包, 造成一定的浪费) 实现传输
+ Pv6中实现了即插即用的功能
在没有DHCP服务器的环境下也能实现IP地址的自动获取.
如果是一个没有路由器的网络, 就使用MAC地址作为链路本地单播地址
而在一个有路由器的网络环境中, 可以从路由器获得IPv6地址的前面部分, 后面部分则由MAC地址进行设置

### DHCP
1. DHCP实现即插即用
为了实现自动设置IP地址、统一管理IP地址分配, 就产生了DHCP(Dynamic Host Configuration Protocol)协议.
有了DHCP, 计算机只要连接到网络, 就可以进行TCP/IP通信, 而DHCP不仅在IPv4中, 在IPv6中也可以使用
2. DHCP的工作机制
使用DHCP之前, 首先要架设一台DHCP服务器(很多时候用该网段的路由器充当DHCP服务器)
然后将DHCP所要分配的IP地址设置到服务器上.将相应的子网掩码、路由控制信息以及DNS服务器的地址等设置到服务器上
关于从DHCP中获取IP地址的流程, 主要分为两个阶段, 在发送DHCP发现包与DHCP请求包时, DHCP即插即用的IP地址尚未确定.
因此, DHCP发现包的目标地址为广播地址255.255.255.255, 而源地址则为0.0.0.0, 表示未知.
+ DHCP服务器
在分配IP地址前发送ICMP回送请求包, 确认没有返回应答.
+ DHCP客户端
针对从DHCP那里获得的IP地址发送ARP请求包, 确认没有返回应答.
3. DHCP中继代理
若有多个以太网(无线LAN)网段, 若要针对每个网段都设置DHCP服务器将会是个庞大的工程.
即使路由器可以分担DHCP的功能, 如果网络中有不下100个路由器, 就要为100个路由器设置它们各自可分配IP地址的范围. 
在这类网络环境中, 往往需要将DHCP统一管理.具体方法可以使用DHCP中继代理来实现
这种方法使得在每个网段架设一个DHCP服务器被取代, 只需在每个网段设置一个DHCP中继代理即可

### NAT
NAT(Network Address Translator)是用于在本地网络中使用私有地址, 
在连接互联网时转而使用全局IP地址的技术
除转换IP地址外, 还出现了可以转换TCP、UDP端口号的NAPT(Network Address PortsTranslator)技术, 
由此可以实现用一个全局IP地址与多个主机的通信(通常人们提到的NAT, 多半是指NAPT.NAPT也叫做IP伪装或MultiNAT)
NAT(NAPT)实际上是为正在面临地址枯竭的IPv4而开发的技术.
不过, 在IPv6中为了提高网络安全也在使用NAT, 在IPv4和IPv6之间的相互通信当中常常使用NAT-PT
NAT![NAT](images/NAT.png)     
1. NAT的工作机制
在NAT(NAPT)路由器的内部, 有一张自动生成的用来转换地址的表
这种转换表在NAT路由器上自动生成.例如, 在TCP的情况下, 建立TCP连接首次握手时的SYN包一经发出, 就会生成这个表.
而后又随着收到关闭连接时发出FIN包的确认应答从表中被删除
NAPT与NAT的区别在于连同端口也缓存到转换表中
TCP或UDP的通信当中, 只有目标地址、源地址、目标端口、源端口以及协议类型(TCP还是UDP)
五项内容都一致时才被认为是同一个通信连接.此时所使用的正是NAPT
2. NAT-PT(NAPT-PT)
PT是Protocol Translatio的缩写.严格来讲NAT-PT用来翻译IP地址, 而NATP-PT则是用来翻译IP首部与端口号的.
NAT-PT是将IPv6的首部转换为IPv4的首部的一种技术.
有了这种技术, 那些只有IPv6地址的主机也就能够与IPv4地址的其他主机进行通信了.
3. NAT的潜在问题
+ 无法从NAT的外部向内部服务器建立连接(虽然可以指定端口号允许向内部访问, 但是数量要受限于全局IP地址的个数)
+ 转换表的生成与转换操作都会产生一定的开销.
+ 通信过程中一旦NAT遇到异常需重新启动时, 所有的TCP连接都将被重置.
解决: IPv6
### 其他IP相关技术
1. IP隧道
IP隧道中可以将那些从网络A发过来的IPv6的包统和为一个数据, 再为之追加一个IPv4的首部以后转发给网络C.
这种在网络层的首部后面继续追加网络层首部的通信方法就叫做“IP隧道"
2. IP多播相关技术
在多播通信中, 确认接收端是否存在非常重要.如果没有接收端, 发送多播消息将会造成网络流量的浪费.
而确认是否有接收端, 要通过MLD(Multicast ListenerDiscovery.多播监听发现) 实现.
IGMP(MLD)主要有两大作用：
+ 向路由器表明想要接收多播消息(并通知想接收多播的地址).
+ 向交换集线器通知想要接收多播的地址.也被称作IGMP(MLD)探听
3. IP任播
IP任播主要用于报警电话110与消防电话119系统.当人们拨打110或119时, 
其接收电话并不是只有一个, 而是可以拨打到一个区域管辖范围内的所有公安或消防部门
IP任播是指为那些提供同一种服务的服务器配置同一个IP地址, 并与最近的服务器进行通信的一种方法
(选择哪个服务器由路由协议的类型和设置方法决定)它可适用于IPv4和IPv6
在IP任播的应用当中最为有名的当属DNS根域名服务器, 使用IP任播可以
让更多的DNS根域名服务器散布到世界的各个角落
4. 通信质量控制
通信线路上的拥塞也叫做收敛.当网络发生收敛时, 路由器和集线器(交换集线器)的队列(Buffer)溢出, 
会出现大量的丢包现象, 从而极端影响通信性能
+ 控制通信质量的机制
控制通信质量的工作机制类似于高速公路上的VIP通道.对于需要保证通信质量的包, 
路由器会进行特殊处理, 并且在力所能及的范围之内对其进行优先处理.通信质量包括带宽、延迟、时延波动等内容
为了控制通信质量, 人们提出了RSVP(Resolution Reservation Protocol) 技术, 它包括两个内容, 
+ 提供点对点的详细优先控制(IntServ)
IntServ是针对特定应用之间的通信进行质量控制的一种机制. 
IntServ也只有在必要的时候才要求在路由器上进行设置, 这也叫“流量设置”.
实现这种流量控制的协议正是RSVP.RSVP中在接收端针对发送端传送控制包, 并在它们之间所有的路由器上进行有质量控制的设定
+ 提供相对较粗粒度的优先控制(DiffServ)
进行DiffServ质量控制的网络叫做DiffServ域.在DiffServ域中的路由器会对所有进入该域IP包首部中的DSCP
(DSCP字段是IP首部TOS字段的替代)字段进行替换.对于期望被优先处理的包设置一个优先值, 
对于没有这种期望的包设置无需优先的值.DiffServ域内部的路由器则根据IP首部的DSCP字段的值有选择性地进行优先处理
5. 显式拥塞通知
TCP虽然也能控制网络拥塞, 不过它是通过数据包的实际损坏情况来判断是否发生拥塞 .
然而这种方法并不能在数据包损坏之前减少数据包的发送量.为了解决这个问题, 
人们在IP层新增了一种使用显式拥塞通知的机制, 即ECN(Explicit Congestion Notification, 显式拥塞通知)
+ ECN的机制概括起来就是在发送包的IP首部中记录路由器是否遇到拥塞, 
并在返回包的TCP首部中通知是否发生过拥塞.拥塞检查在网络层进行, 
而拥塞通知则在传输层进行, 这两层的互相协助实现了拥塞通知的功能.
6. Mobile IP
Mobile IP这种技术在主机所连接的子网IP发生变化时, 主机IP地址仍保持不变.
应用不需要做任何改动, 即使是在IP地址发生变化的环境下, 通信也能够继续
+ 移动主机(MH：Mobile Host)
是指那些移动了位置, IP地址却不变的设备.
在没移动的时候, 所连接的网络叫做归属网络, IP地址叫做归属地址.归属地址如同一个人的户籍, 移动也不会改变地址.
即使移动了也会被设置成所处子网中的IP地址.这种地址被称为移动地址(CoA：Care-of Address)
+ 外部代理(FA：Foreighn Agent)
使用于支持移动主机的移动设备.所有需要接入网络的移动主机都需要它.
如图5.30, Mobile IP中的移动主机, 在移动之前按照以往的模式进行通信, 
而移动之后则通过外部代理发送转发数据包向归属代理通知自己的地址.
从应用层看移动主机, 会发现它永远使用归属地址进行通信.然而, 实际上Mobile IP是使用转交地址转发数据包的.
+ Mobile IPv6
外部代理会限制网络是否通信, 且效率不高. Mobile IPv6解决了这些问题
外部代理的功能由市县Mobile IPv6的移动主机自己承担.
考虑路径最优化, 可以不用经过归属代理进行直接通信
IPv6首部的源地址中赋与移动地址, 不让防火墙丢弃
只是移动主机和通信对端的主机都需要支持Mobile IPv6

## 六 TCP与UDP
TCP(Transmission ControlProtocol)与UDP(User Datagram Protocol)
TCP提供可靠的通信传输, 而UDP则常被用于让广播和细节控制交给应用的通信传输
### 传输层
1. 定义
IP首部中有一个协议字段, 用来标识网络层(IP)的上一层所采用的是哪一种传输层协议.
根据这个字段的协议号, 就可以识别IP传输的数据部分究竟是TCP的内容, 还是UDP的内容.
同样, 传输层的TCP和UDP, 为了识别自己所传输的数据部分究竟应该发给哪个应用, 
也设定了这样一个编号, 也就是端口号这样一种识别码
2. 通信处理
TCP/IP的众多应用协议大多以客户端/服务端的形式运行.
+ 客户端(客户端(Client)具有客户的意思.在计算机网络中是提供服务和使用服务的一方) 
类似于客户的意思, 是请求的发起端.
+ 服务端(服务端(Server)在计算机网络中则意味着提供服务的程序或计算机) 
则表示提供服务的意思, 是请求的处理端.另外, 作为服务端的程序有必要提前启动, 准备接收客户端的请求
+ 服务端程序在UNIX系统当中叫做守护进程.
例如HTTP的服务端程序是httpd(HTTP守护进程), 而ssh的服务端程序是sshd(SSH守护进程).
在UNIX中并不需要将这些守护进程逐个启动, 而是启动一个可以代表它们接收客户端请求的inetd(互联网守护进程)服务程序.
它是一种超级守护进程.该超级守护进程收到客户端请求以后会创建(fork)新的进程并转换(exec)为sshd等各个守护进程
+ 确认一个请求究竟发给的是哪个服务端(守护进程), 可以通过所收到数据包的目标端口号轻松识别
3. 两种传输层协议TCP和UDP
+ TCP
TCP是面向连接的、可靠的流协议.流就是指不间断的数据结构, 你可以把它想象成排水管道中的水流.
当应用程序采用TCP发送消息时, 虽然可以保证发送的顺序, 但还是犹如没有任何间隔的数据流发送给接收端
(发送端发送10次100字节, 服务端可以只接受1次1000字节)
TCP为提供可靠性传输, 实行“顺序控制”或“重发控制”机制.此外还具备“流控制(流量控制)”、“拥塞控制”、提高网络利用率等
+ UDP
UDP是不具有可靠性的数据报协议.细微的处理它会交给上层的应用去完成.
在UDP的情况下, 虽然可以确保发送消息的大小却不能保证消息一定会到达
4. TCP与UDP区分
**TCP用于在传输层有必要实现可靠传输的情况**.由于它是面向有连接并具备顺序控制、重发控制等机制的, 
所以它可以为应用提供可靠传输
**UDP主要用于那些对高速传输和实时性有较高要求的通信或广播通信**
+ 套接字(Socket)
应用在使用TCP或UDP时, 会用到操作系统提供的类库.
这种类库一般被称为API(Application Programming Interface, 应用编程接口).
使用TCP或UDP通信时, 又会广泛使用到套接字(socket)的API.
应用程序利用套接字, 可以设置对端的IP地址、端口号, 并实现数据的发送与接收
### 端口号
1. 定义
数据链路和IP中的地址, 分别指的是MAC地址和IP地址.
前者用来识别同一链路中不同的计算机, 后者用来识别TCP/IP网络中互连的主机和路由器.
在传输层中也有这种类似于地址的概念, 那就是端口号.端口号用来识别同一台计算机中进行通信的不同应用程序.
因此, 它也被称为程序地址
2. 通过IP地址、端口号、协议号进行通信识别
TCP/IP或UDP/IP通信中通常采用5个信息来识别(**netstat -n**) 一个通信.
**它们是“源IP地址”、“目标IP地址”、“协议号”、“源端口号”、“目标端口号”**.只要其中某一项不同, 则被认为是其他通信
源IP地址: 区分两台计算机
源端口号: 打开两个Web浏览器, 同时访问两个服务器上不同的页面, 就会在这个浏览器跟服务器之间产生类似前面的两个通信
协议号: IP地址和端口全都一样, 只是协议号(表示上层是TCP或UDP的一种编号)不同
![在这里插入图片描述](images/通信识别.png)     
3. 端口号如何确定
标准既定的端口号(静态方法): 
关于知名端口号以及注册端口号的最新消息：http://www.iana.org/assignments/port-numbers
| 协议| TCP server端口号| client端口号|
| -- | -- | -- | 
| HTTP | 80| 2001 |
| HTTPS | 443|  |
| FTP | 21| 2000 |
| SSH | 22|  |
| SMTP | 25| |
时序分配法 (或动态分配法):
此时, 服务端有必要确定监听端口号, 但是接受服务的客户端没必要确定端口号
操作系统可以为每个应用程序分配互不冲突的端口号,例如, 每需要一个新的端口号时, 就在之前分配号码的基础上加1
动态分配的端口号取值范围在49152到65535之间
4. 端口号与协议
端口号由其使用的传输层协议决定.因此, 不同的传输协议可以使用相同的端口号
例如, TCP与UDP使用同一个端口号, 但使用目的各不相同.这是因为端口号上的处理是根据每个传输协议的不同而进行的
这是因为, 数据到达IP层后, 会先检查IP首部中的协议号, 再传给相应协议的模块

### UDP
UDP是User Datagram Protocol的缩写.(UDP的“用户”(User)其实就相当于程序员)
+ UDP不提供复杂的控制机制, 利用IP提供面向无连接的通信服务.
并且它是将应用程序发来的数据在收到的那一刻, 立即按照原样发送到网络上的一种机制.
+ UDP也无法进行流量控制等避免网络拥塞的行为.
+ 此外, 传输途中即使出现丢包, UDP也不负责重发.
+ 甚至当出现包的到达顺序乱掉时也没有纠正的功能.如果需要这些细节控制, 那么不得不交由采用UDP的应用程序去处理
+ UDP按照“制作程序的那些用户的指示行事”.
+ UDP面向无连接, 它可以随时发送数据.再加上UDP本身的处理既简单又高效, 因此经常用于以下几个方面：
    包总量较少的通信(DNS、SNMP等)
    视频、音频等多媒体通信(即时通信)
    限定于LAN等特定网络中的应用通信
    广播通信(广播、多播)

### TCP
TCP可以说是对“传输、发送、通信”进行“控制”的“协议”.
+ 它可以进行丢包时的重发控制, 
+ 还可以对次序乱掉的分包进行顺序控制
+ 此外, TCP作为一种面向有连接的协议, 只有在确认通信对端存在时才会发送数据, 从而可以控制通信流量的浪费
根据TCP的这些机制, 在IP这种无连接的网络上也能够实现高可靠性的通信
1. TCP的特点及其目的
TCP通过检验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠性传输
2. 通过序列号与确认应答实现可靠传输
在TCP中, 当发送端的数据到达接收主机时, 接收端主机会返回一个已收到消息的通知.这个消息叫做确认应答
(ACK(ACK(PositiveAcknowled-gement)意指已经接收)
+ 在一定时间内没有等到确认应答, 发送端就可以认为数据已经丢失, 并进行重发.
由此, 即使产生了丢包, 仍然能够保证数据能够到达对端, 实现可靠传输
+ 未收到确认应答并不意味着数据一定丢失.也有可能是数据对方已经收到, 只是返回的确认应答在途中丢失
源发送主机只要按照机制重发数据即可, 接收主机接收到相同数据时会丢弃掉
+ 为此, 就必须引入一种机制, 它能够识别是否已经接收数据, 又能够判断是否需要接收
**上述这些确认应答处理、重发控制以及重复控制等功能都可以通过序列号实现**
序列号是按顺序给发送数据的每一个字节(8位字节)都标上号码的编号
(序列号的初始值并非为0.而是在建立连接以后由随机数生成.而后面的计算则是对每一字节加一) 
接收端查询接收数据TCP首部中的序列号和数据的长度, 将自己下一步应该接收的序号作为确认应答返送回去.
就这样, 通过序列号和确认应答号, TCP可以实现可靠传输
3. 重发超时如何确定
重发超时是指在重发数据之前, 等待确认应答到来的那个特定时间间隔.如果超过了这个时间仍未收到确认应答, 发送端将进行数据重发
+ TCP要求不论处在何种网络环境下都要提供高性能通信, 并且无论网络拥堵情况发生何种变化, 都必须保持这一特性.
为此, 它在每次发包时都会计算往返时间(Round Trip Time也叫RTT.是指报文段的往返时间) 
及其偏差(RTT时间波动的值、方差.有时也叫抖动)将这个往返时间和偏差相加重发超时的时间, 就是比这个总和要稍大一点的值.
+ 重发超时的计算既要考虑往返时间又要考虑偏差是有其原因.根据网络环境的不同往返时间可能会产生大幅度的摇摆, 
之所以发生这种情况是因为数据包的分段是经过不同线路到达的.TCP/IP的目的是即使在这种环境下也要进行控制, 尽量不要浪费网络流量
4. 连接管理
TCP提供面向有连接的通信传输.面向有连接是指在数据通信开始之前先做好通信两端之间的准备工作
+ 在数据通信之前, 通过TCP首部发送一个SYN包作为建立连接的请求等待确认应答
(TCP中发送第一个SYN包的一方叫做客户端, 接收这个的一方叫做服务端)
如果对端发来确认应答, 则认为可以进行数据通信.如果对端的确认应答未能到达, 就不会进行数据通信.
此外, 在通信结束时会进行断开连接的处理(FIN包)
+ 可以使用TCP首部用于控制的字段来管理TCP连接(也叫控制域)
+ 一个连接的建立与断开, 正常过程至少需要来回发送7个包才能完成
+ 建立一个TCP连接需要发送3个包.这个过程也称作“三次握手”
client向server发起SYN请求连接
server针对SYN返回ACK, 同时server发起SYN, 请求与client建立连接, 此时ACK和SYN是在一个连接中
最后client向server发送ACK确认SYN
+ 断开一个TCP连接
client向server发起FIN请求断开连接
server针对SYN返回ACK, 经过对连接中请求进行处理后
server发起FIN, 请求与client切断连接, CK和SYN是在两个连接中
最后client向server发送ACK确认FIN
5. TCP以段为单位发送数据
在建立TCP连接的同时, 也可以确定发送数据包的单位, 我们也可以称其为“最大消息长度”(MSS：Maximum Segment Size)
最理想的情况是, 最大消息长度正好是IP中不会被分片处理的最大数据长度
+ MSS是在三次握手的时候, 在两端主机之间被计算得出.
两端的主机在发出建立连接的请求时, 会在TCP首部中写入MSS选项, 告诉对方自己的接口能够适应的MSS的大小
然后会在两者之间选择一个较小的值投入使用
6. 利用窗口控制提高速度
TCP以1个段为单位, 每发一个段进行一次确认应答的处理,下一次的处理要等到收到当前应答后才开始, 
这样的传输方式有一个缺点.那就是, 包的往返时间越长通信性能就越低.
+ 为解决这个问题, TCP引入了窗口这个概念.即使在往返时间较长的情况下, 它也能控制网络性能的下降
确认应答不再是以每个分段, 而是以更大的单位进行确认时, 转发时间将会被大幅度的缩短.
也就是说, 发送端主机, 在发送了一个段以后不必要一直等待确认应答, 而是继续发送
![在这里插入图片描述](images/TCP窗口.png)      
窗口大小就是指无需等待确认应答而可以继续发送数据的最大值
这个机制实现了使用大量的缓冲区(缓冲区(Buffer)在此处表示临时保存收发数据的场所.
通常是在计算机内存中开辟的一部分空间) , 通过对多个段同时进行确认应答的功能
+ 为了实现重发, 发送端主机在等到确认应答返回之前, 必须在缓冲区中保留这部分数据, 直到收到确认应答
+ 滑动窗口控制
收到确认应答的情况下, 将窗口滑动到确认应答中的序列号的位置.这样可以顺序地将多个段同时发送提高通信性能.
7. 窗口控制与重发控制
+ 确认应答未能返回
数据已经到达对端, 是不需要再进行重发的.
使用了窗口控制, 即使少部分的确认应答丢失也不会数据重发, 可以通过下一个确认应答进行确认
+ 某个报文段丢失
当某一报文段丢失后, 发送端会一直收到序号为1001的确认应答, 这个确认应答好像在提醒发送端“我想接收的是从1001开始的数据”.
因此, 在窗口比较大, 又出现报文段丢失的情况下, 同一个序号的确认应答将会被重复不断地返回.
而发送端主机如果连续3次收到同一个确认应答(之所以连续收到3次而不是两次的理由是因为, 即使数据段的序号被替换两次也不会触发重发机制) , 
就会将其所对应的数据进行重发, 这种机制比之前提到的超时管理更加高效, 因此也被称作高速重发控制
![在这里插入图片描述](images/高速重发控制.png)    
8. 流控制
接收端忙于处理其他请求, 暂时无法接受数据, 将本应该接收的数据丢弃的话, 就又会触发重发机制. 
+ 为了防止这种现象的发生, TCP提供一种机制可以让发送端根据接收端的实际接收能力控制发送的数据量.这就是所谓的流控制
+ 它的具体操作是, 接收端主机向发送端主机通知自己可以接收数据的大小, 于是发送端会发送不超过这个限度的数据.该大小限度就被称作窗口大小
+ TCP首部中, 专门有一个字段用来通知窗口大小.接收主机将自己可以接收的缓冲区大小放入这个字段中通知给发送端.
这个字段的值越大, 说明网络的吞吐量越高
+ 发送端主机会根据接收端主机的指示, 对发送数据的量进行控制.这也就形成了一个完整的TCP流控制(流量控制)
9. 拥塞控制
在网络出现拥堵时, 如果突然发送一个较大量的数据, 极有可能会导致整个网络的瘫痪.
TCP为了防止该问题的出现, 在通信一开始时就会通过一个叫做慢启动的算法得出的数值, 对发送数据量进行控制
+ 为了在发送端调节所要发送数据的量, 定义了一个叫做“拥塞窗口”的概念
+ 慢启动的时候, 将这个拥塞窗口的大小设置为1个数据段(1MSS)发送数据, 之后每收到一次确认应答(ACK), 拥塞窗口的值就加1.
在发送数据包时, 将拥塞窗口的大小与接收端主机通知的窗口大小做比较, 然后按照它们当中较小那个值, 发送比其还要小的数据量.
+ 如果重发采用超时机制, 那么拥塞窗口的初始值可以设置为1以后再进行慢启动修正
+ 慢启动阀值
为了防止拥塞窗口增加的过快导致网络拥塞, 只要拥塞窗口的值超出这个阀值, 在每收到一次确认应答时, 只允许以下面这种比例放大拥塞窗口
(1个数据段的字节数/拥塞窗口字节数)*1个数据段的字节数
TCP的通信开始时, 并没有设置相应的慢启动阀值(与窗口的最大值相同) 而是在超时重发时, 才会设置为当时拥塞窗口一半的大小.
+ 由重复确认应答而触发的高速重发与超时重发机制的处理多少有些不同.
因为前者要求至少3次的确认应答数据段到达对方主机后才会触发, 相比后者网络的拥堵要轻一些
重复确认应答进行高速重发控制时, 慢启动阀值的大小被设置为当时窗口大小的一半.然后将窗口的大小设置为该慢启动阀值+3个数据段
+ 当TCP通信开始以后, 网络吞吐量会逐渐上升, 但是随着网络拥堵的发生吞吐量也会急速下降.于是会再次进入吞吐量慢慢上升的过程.
因此所谓TCP的吞吐量的特点就好像是在逐步占领网络带宽的感觉
10. 提高网络利用率的规范
+ Nagle算法
该算法是指发送端即使还有应该发送的数据, 但如果这部分数据很少的话, 则进行延迟发送的一种处理机制
具体来说, 就是仅在下列任意一种条件下才能发送数据.
+ + 已发送的数据都已经收到确认应答时
+ + 可以发送最大段长度(MSS)的数据时
根据这个算法虽然网络利用率可以提高, 但是可能会发生某种程度的延迟
+ 延迟确认应答
接收数据的主机如果每次都立刻回复确认应答的话, 可能会返回一个较小的窗口.那是因为刚接收完数据, 缓冲区已满.
当某个接收端收到这个小窗口的通知以后, 会以它为上限发送数据, 从而又降低了网络的利用率
为此, 引入了一个方法, 那就是收到数据以后并不立即返回确认应答, 而是延迟一段时间的机制
+ + TCP采用滑动窗口的控制机制, 因此通常确认应答少一些也无妨.
TCP文件传输中, 绝大多数是每两个数据段返回一次确认应答.
+ 捎带应答
TCP的确认应答和回执数据可以通过一个包发送.这种方式叫做捎带应答. 
不过确认应答必须得等到应用处理完数据并将作为绘制的数据返回为止, 才能进行捎带应答
接收数据以后如果立刻返回确认应答, 就无法实现捎带应答.
**如果需要应用自己处理一些更为细节上的控制, 使用UDP协议是不错的选择.**
**如果转发数据量较多、对可靠性的要求比较高时, 可以选择使用TCP**
### 其他传输层协议
1. UDP-Lite
UDP-Lite(Lightweight User Datagram Protocol, 轻量级用户数据报协议)是扩展UDP机能的一种传输层协议
在基于UDP的通信当中如果校验和出现错误, 所收到的包将被全部丢弃
UDP-Lite提供与UDP几乎相同的功能, 不过计算校验和的范围可以由应用自行决定
2. SCTP
SCTP(Stream Control Transmission Protocol, 流控制传输协议)
(SS7协议最初被应用于TCP/IP上时, 由于TCP本身使用起来不是很方便, 所以人们开发了SCTP协议.今后它可能会出现各种各样的使用途径) 
与TCP一样, 都是对一种提供数据到达与否相关可靠性检查的传输层协议
其主要特点如下：
以消息为单位收发
TCP中接收端并不知道发送端应用所决定的消息大小.在SCTP中却可以.
支持多重宿主
在有多个NIC的主机中, 即使其中能够使用的NIC发生变化, 也仍然可以继续通信(这与TCP相比提高了故障应对能力)
支持多数据流通信
TCP中建立多个连接以后才能进行通信的效果, 在SCTP中一个连接就可以.(吞吐量得到有效提升)
可以定义消息的生存期限
超过生存期限的消息, 不会被重发.
SCTP主要用于进行通信的应用之间发送众多较小消息的情况.这些较小的应用消息被称作数据块(Chunk), 多个数据块组成一个数据包.
此外, SCTP具有支持多重宿主以及设定多个IP地址的特点.
多重宿主是指同一台主机具备多种网络的接口.例如, 笔记本电脑既可以连接以太网又可以连接无线LAN.
3. DCCP
DCCP(Datagram Congestion Control Protocol, 数据报拥塞控制协议)是一个辅助UDP的崭新的传输层协议.
UDP没有拥塞控制机制.为此, 当应用使用UDP发送大量数据包时极容易出现问题.互联网中的通信, 即使使用UDP也应该控制拥塞
### 首部的格式
1. UDP: 源端口号(Source Port),目标端口号(Destination Port),  包长度(Length), 校验和(Checksum)
UDP数据报没有IP地址这极有可能会导致应该收包的应用收不到包, 不该收到包的应用却收到了包
所以, 接收主机在收到UDP数据报以后, 从IP首部获知IP地址信息构造UDP伪首部, 再进行校验和计算.
2. TCP
![在这里插入图片描述](images/TCP首部.png)    

## 七 路由协议

## 八 应用协议
+ 应用协议的定义
利用网络的应用程序有很多，包括Web 浏览器、电子邮件、远程登录、文件传输、网络管理等。
能够让这些应用进行特定通信处理的正是应用协议
+ 分层
为了实现网络应用的功能，在应用之间进行通信时将其连接的网络协议是非常重要的
（应用之间交互的信息叫消息。应用协议定义这些消息的格式以及使用这些消息进行控制或操作的规则。）
应用可以直接享用传输层以下的基础部分

### 远程登录
远程登录是为了实现TSS（Time Sharing System）分时系统。）环境，是将主机和终端的关系应用到计算机网络上的一个结果。
TSS中通常有一个处理能力非常强的主机，围绕着这台主机的是处理能力没有那么强的多个终端机器。
类似地，实现从自己的本地计算机登录到网络另一端计算功能的应用就叫做远程登录
1. TELNET
TELNET利用TCP的一条连接，通过这一条连接向主机发送文字命令并在主机上执行。
本地用户好像直接与远端主机内部的Shell相连(Shell是操作系统提供给用户的、便于使用该系统中各种功能的一种用户接口)
TELNET可以分为两类基本服务。一是仿真终端功能，二是协商选项机制
+ TELNET客户端
所谓TELNET客户端是指利用TELNET协议实现远程登录的客户端程序
TELNET客户端通常与目标主机的23号端口建立连接，并与监听这个端口的服务端程序telnetd进行交互。
当然，也可以与其他的TCP端口号连接，只要在该端口上有监听程序能够处理telnet请求即可
以下两个命令可以视为相同：
ftp 主机名
telnet 主机名 21
2. SSH
SSH是加密的远程登录系统。TELNET中登录时无需输入密码就可以发送，容易造成通信窃听和非法入侵的危险。
使用SSH后可以加密通信内容, SSH还包括很多非常方便的功能：
+ 可以使用更强的认证机制。
+ 可以转发文件（UNIX中可以使用scp、sftp等命令。） 。
+ 可以使用端口转发功能（可以通过X Window System串口展现。）
端口转发是指将特定端口号所收到的消息转发到特定的IP地址和端口号码的一种机制, 
此时, SSH客户端程序和SSH服务端程序都起着网关的作用.
